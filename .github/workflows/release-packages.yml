name: Build Packages

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    env:
      CARGO_TERM_COLOR: always
      APP_NAME: faugus-launcher-rs
      BIN_NAME: faugus-launcher-rs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ruby \
            ruby-dev \
            rpm \
            zstd \
            libarchive-tools \
            jq \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            fakeroot
          sudo gem install --no-document fpm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release

      - name: Prepare staging
        run: |
          VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].version')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Binary
          mkdir -p dist/root/usr/bin
          cp target/release/${BIN_NAME} dist/root/usr/bin/
          chmod 755 dist/root/usr/bin/${BIN_NAME}
          
          # Assets
          mkdir -p dist/root/usr/share/faugus-launcher/assets
          cp -r assets/* dist/root/usr/share/faugus-launcher/assets/
          
          # Desktop Entry
          mkdir -p dist/root/usr/share/applications
          cat > dist/root/usr/share/applications/faugus-launcher-rs.desktop <<EOF
          [Desktop Entry]
          Categories=Game;Utility;
          Comment=Lightweight launcher for Windows games on Linux using UMU-Launcher
          Exec=${BIN_NAME} %f
          Icon=faugus-launcher
          MimeType=application/x-ms-dos-executable;application/x-msi;application/x-ms-shortcut;application/x-bat;text/x-ms-regedit
          Name=Faugus Launcher (Rust)
          Terminal=false
          Type=Application
          StartupNotify=true
          EOF
          
          # Icons
          mkdir -p dist/root/usr/share/icons/hicolor/512x512/apps
          mkdir -p dist/root/usr/share/icons/hicolor/scalable/apps
          cp assets/faugus-launcher.png dist/root/usr/share/icons/hicolor/512x512/apps/faugus-launcher.png
          cp assets/faugus-mono.svg dist/root/usr/share/icons/hicolor/scalable/apps/faugus-launcher.svg

      - name: Package Debian (.deb)
        run: |
          fpm -s dir -t deb \
            -n ${APP_NAME} \
            -v ${VERSION} \
            -C dist/root \
            --description "Faugus Launcher (Rust)" \
            --license MIT \
            --maintainer "@0FL01" \
            --architecture amd64

      - name: Package Fedora (.rpm)
        run: |
          fpm -s dir -t rpm \
            -n ${APP_NAME} \
            -v ${VERSION} \
            -C dist/root \
            --description "Faugus Launcher (Rust)" \
            --license MIT \
            --maintainer "@0FL01" \
            --architecture x86_64

      - name: Package Arch (.pkg.tar.zst)
        run: |
          fpm -s dir -t pacman \
            -n ${APP_NAME} \
            -v ${VERSION} \
            -C dist/root \
            --description "Faugus Launcher (Rust)" \
            --license MIT \
            --maintainer "@0FL01" \
            --architecture x86_64

      - name: Package universal tarball (.tar.zst)
        run: |
          tar --directory=dist/root -c . | zstd -19 -o ${APP_NAME}-${VERSION}-linux-x86_64.tar.zst

      - name: Collect artifacts
        run: |
          mkdir -p dist/out
          mv *.deb dist/out/ || true
          mv *.rpm dist/out/ || true
          mv *.pkg.tar.zst dist/out/ || true
          mv ${APP_NAME}-${VERSION}-linux-x86_64.tar.zst dist/out/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: faugus-launcher-packages
          path: dist/out
