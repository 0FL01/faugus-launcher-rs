name: Build Packages

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      CARGO_TERM_COLOR: always
      APP_NAME: faugus-launcher
      BIN_NAME: faugus-launcher
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ruby \
            ruby-dev \
            rpm \
            zstd \
            libarchive-tools \
            jq \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            fakeroot
          sudo gem install --no-document fpm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binaries
        run: cargo build --release --bins

      - name: Prepare staging
        run: |
          BASE_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].version')
          if [ "$GITHUB_EVENT_NAME" == "push" ]; then
            VERSION="${BASE_VERSION}.nightly.${GITHUB_SHA::7}"
          else
            VERSION="$BASE_VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Binaries
          mkdir -p dist/root/usr/bin
          cp target/release/${BIN_NAME} dist/root/usr/bin/
          chmod 755 dist/root/usr/bin/${BIN_NAME}

          # faugus-run CLI binary
          cp target/release/faugus-run dist/root/usr/bin/
          chmod 755 dist/root/usr/bin/faugus-run
          
          # Assets
          mkdir -p dist/root/usr/share/faugus-launcher/assets
          cp -r assets/* dist/root/usr/share/faugus-launcher/assets/
          
          # Desktop Entry
          mkdir -p dist/root/usr/share/applications
          cat > dist/root/usr/share/applications/io.github.Faugus.faugus-launcher.desktop <<EOF
          [Desktop Entry]
          Categories=Game;Utility;
          Comment=Lightweight launcher for Windows games on Linux using UMU-Launcher
          Exec=${BIN_NAME} %f
          Icon=faugus-launcher
          MimeType=application/x-ms-dos-executable;application/x-msi;application/x-ms-shortcut;application/x-bat;text/x-ms-regedit
          Name=Faugus Launcher
          Terminal=false
          Type=Application
          StartupNotify=true
          EOF

          # faugus-run CLI desktop entry (for testing/CLI usage)
          cat > dist/root/usr/share/applications/faugus-run.desktop <<EOF
          [Desktop Entry]
          Categories=Game;Utility;
          Comment=CLI launcher for Windows games on Linux
          Exec=faugus-run --game %u
          Icon=faugus-launcher
          Name=Faugus Run (CLI)
          Terminal=true
          Type=Application
          StartupNotify=true
          EOF
          
          # Icons
          mkdir -p dist/root/usr/share/icons/hicolor/512x512/apps
          mkdir -p dist/root/usr/share/icons/hicolor/scalable/apps
          cp assets/faugus-launcher.png dist/root/usr/share/icons/hicolor/512x512/apps/faugus-launcher.png
          cp assets/faugus-mono.svg dist/root/usr/share/icons/hicolor/scalable/apps/faugus-launcher.svg

      - name: Package Debian (.deb)
        run: |
          fpm -s dir -t deb \
            -n ${APP_NAME} \
            -v ${VERSION} \
            -C dist/root \
            --description "Faugus Launcher (Rust)" \
            --license MIT \
            --maintainer "@0FL01" \
            --architecture amd64

      - name: Package Fedora (.rpm)
        run: |
          fpm -s dir -t rpm \
            -n ${APP_NAME} \
            -v ${VERSION} \
            -C dist/root \
            --description "Faugus Launcher (Rust)" \
            --license MIT \
            --maintainer "@0FL01" \
            --architecture x86_64

      - name: Package Arch (.pkg.tar.zst)
        run: |
          fpm -s dir -t pacman \
            -n ${APP_NAME} \
            -v ${VERSION} \
            -C dist/root \
            --description "Faugus Launcher (Rust)" \
            --license MIT \
            --maintainer "@0FL01" \
            --architecture x86_64

      - name: Package universal tarball (.tar.zst)
        run: |
          tar --directory=dist/root -c . | zstd -19 -o ${APP_NAME}-${VERSION}-linux-x86_64.tar.zst

      - name: Collect artifacts
        run: |
          mkdir -p dist/out
          mv *.deb dist/out/ || true
          mv *.rpm dist/out/ || true
          mv *.pkg.tar.zst dist/out/ || true
          mv ${APP_NAME}-${VERSION}-linux-x86_64.tar.zst dist/out/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event_name == 'push' && format('faugus-launcher-packages-nightly-{0}', github.sha) || 'faugus-launcher-packages' }}
          path: dist/out

      - name: Create Nightly Release
        if: ${{ github.event_name == 'push' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly Build
          draft: false
          prerelease: true
          target_commitish: ${{ github.sha }}
          files: dist/out/*

      - name: Create GitHub Release
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.create_release == true }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: Release ${{ inputs.release_tag }}
          draft: false
          prerelease: false
          files: |
            dist/out/*.deb
            dist/out/*.rpm
            dist/out/*.pkg.tar.zst
            dist/out/*.tar.zst
